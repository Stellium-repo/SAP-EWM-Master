<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZSCWM_RF_REHU_HU_SEL_IPL_PAI</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for function: ZSCWM_RF_REHU_HU_SEL_IPL_PAI</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  HU selection for screen 301</b></font>
<hr>
<pre width="100">
<font color ="#0000FF">*****************************************************************************************</font>
<font color ="#0000FF">*                          INTAS PHARMA                                                 *</font>
<font color ="#0000FF">*****************************************************************************************</font>
<font color ="#0000FF">*  OBJECT INFORMATION                                                                   *</font>
<font color ="#0000FF">*****************************************************************************************</font>
<font color ="#0000FF">* Module             : EWM                                                              *</font>
<font color ="#0000FF">* Developer          : Vinoth Kumar Raja                                                *</font>
<font color ="#0000FF">* Requestor          : Shylaja                                                          *</font>
<font color ="#0000FF">* Date Of Creation   : 23.09.2022                                                       *</font>
<font color ="#0000FF">* Transport Request  : EWDK900104                                                       *</font>
<font color ="#0000FF">* Development Object : ZSCWM_RF_REHU_HU_SEL_IPL_PAI                                     *</font>
<font color ="#0000FF">* Description        : HU selection for screen 301                                      *</font>
<font color ="#0000FF">*                                                                                       *</font>
<font color ="#0000FF">*=======================================================================================*</font>
<font color ="#0000FF">* MODIFICATION HISTORY                                                                  *</font>
<font color ="#0000FF">*---------------------------------------------------------------------------------------*</font>
<font color ="#0000FF">* Mod. No.  Date    Name        Transport Number        Change Desc.                    *</font>
<font color ="#0000FF">*---------------------------------------------------------------------------------------*</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*---------------------------------------------------------------------------------------*</font>

<font color ="#0000FF">*       <a href ="global-zscwm_rf_rehu_hu_sel_ipl_pai.html">Global data declarations</a></font>
FUNCTION zscwm_rf_rehu_hu_sel_ipl_pai.
<font color ="#0000FF">*"----------------------------------------------------------------------</font>
<font color ="#0000FF">*"*"Local Interface:</font>
<font color ="#0000FF">*"  CHANGING</font>
<font color ="#0000FF">*"     REFERENCE(CS_REHU_HU) TYPE  /SCWM/S_RF_REHU_HU</font>
<font color ="#0000FF">*"     REFERENCE(CT_REHU_HU) TYPE  /SCWM/TT_RF_REHU_HU</font>
<font color ="#0000FF">*"     REFERENCE(CS_REHU) TYPE  /SCWM/S_RF_ADMIN_REHU</font>
<font color ="#0000FF">*"     REFERENCE(CS_REHU_PROD) TYPE  /SCWM/S_RF_REHU_PROD</font>
<font color ="#0000FF">*"     REFERENCE(CT_REHU_PROD) TYPE  /SCWM/TT_RF_REHU_PROD</font>
<font color ="#0000FF">*"     REFERENCE(CS_REHU_DLV) TYPE  /SCWM/S_RF_UNLO_DOCID</font>
<font color ="#0000FF">*"----------------------------------------------------------------------</font>
  DATA: lv_fcode      TYPE /scwm/de_fcode.

  DATA: ls_huhdr  TYPE /scwm/s_huhdr_int,
        ls_k_item TYPE  /scdl/s_sp_k_item,
        lt_k_item TYPE  /scdl/t_sp_k_item.

  DATA: lt_huitm                   TYPE /scwm/tt_huitm_int,
        lv_exist                   TYPE xfeld,
        ev_rejected                TYPE boole_d,            "#EC NEEDED
        lt_rcode                   TYPE /scdl/t_sp_return_code, "#EC NEEDED
        lv_exist_in_other_delivery TYPE xfeld,
        lv_field(60)               TYPE c.

  DATA: lt_hu_guids TYPE /scwm/tt_guid_hu,
        ls_hu_guids TYPE /scwm/s_guid_hu.

  DATA: lo_prd2hum TYPE REF TO /scwm/cl_dlv_prd2hum.

  DATA: lo_ewl_manager       TYPE REF TO /scwm/if_api_lm_ewl_manager,
        lv_timestamp_current TYPE timestamp.

  DATA: lv_value  TYPE string,
        lv_index  TYPE i,
        lv_length TYPE i,
        lv_char   TYPE c,
        lv_add    TYPE c,
        lv_ean    TYPE /sapapo/ean11,
        lv_batch  TYPE char10.

  FIELD-SYMBOLS: &lt;fs_huitm&gt; TYPE /scwm/s_huitm_int.

  DATA :lt_matid   TYPE /scwm/tt_matid_matnr,
        ls_matnr   TYPE rsdsselopt,
        ls_matid   TYPE /scwm/s_matid_matnr,
        ls_huhead  TYPE  /scwm/s_huhdr_int,
        lv_huident TYPE  /scwm/huident,
        lt_matnr   TYPE rseloption,
        lv_char40  TYPE /scwm/de_rf_text.

  DATA:ls_ean128_data   TYPE  /scwm/ean128.

<font color ="#0000FF">*----------------------------------------------------------------------*</font>
<font color ="#0000FF">* Program logic                                                        *</font>
<font color ="#0000FF">*----------------------------------------------------------------------*</font>
  BREAK-POINT ID /scwm/rf_receiving_hus.

  CLEAR: ct_rehu_prod, cs_rehu_prod, cs_rehu_dlv.

  /scwm/cl_api_factory=&gt;get_service( IMPORTING eo_api = lo_ewl_manager ).
  /scwm/cl_rf_bll_srvc=&gt;set_prmod( gc_prmod_foregr ).

  DATA(lv_fcode1) = /scwm/cl_rf_bll_srvc=&gt;get_fcode( ).

  IF lv_fcode1 = 'LISTF'.
    DATA(lv_dfield)  = /scwm/cl_rf_bll_srvc=&gt;get_cursor_field( ).
    IF lv_dfield EQ '/SCWM/S_RF_REHU_HU-NEW_PACKMAT'.
      CALL METHOD /scwm/cl_rf_bll_srvc=&gt;init_listbox
        EXPORTING
          iv_fieldname = '/SCWM/S_RF_REHU_HU-NEW_PACKMAT'.
      SELECT  param_value FROM zparam_details
                INTO TABLE @DATA(lt_pmat)
                WHERE lgnum     EQ @cs_rehu-lgnum
                AND   reqname   EQ 'PMATERIAL LIST'.
      IF lt_pmat IS NOT INITIAL.
        LOOP AT lt_pmat ASSIGNING FIELD-SYMBOL(&lt;fs_pmat&gt;).
          CLEAR lv_char40.
          MOVE &lt;fs_pmat&gt;-param_value TO lv_char40.
          CALL METHOD /scwm/cl_rf_bll_srvc=&gt;insert_listbox
            EXPORTING
              iv_fieldname      = '/SCWM/S_RF_REHU_HU-NEW_PACKMAT'
              iv_add_dest_field = '/SCWM/S_RF_REHU_HU-NEW_PACKMAT'
              iv_value          = lv_char40
              iv_text           = lv_char40.
        ENDLOOP.
        /scwm/cl_rf_bll_srvc=&gt;set_prmod( '1' ).
        /scwm/cl_rf_bll_srvc=&gt;set_fcode( 'LIST' ).
      ENDIF.
    ENDIF.
    RETURN.
  ENDIF.

  IF lv_fcode1 = 'ENTER'.
    IF cs_rehu_hu-new_packmat IS INITIAL.
      RETURN.
      MESSAGE 'Please enter Packaging Material' TYPE 'E'.
    ENDIF.
<font color ="#0000FF">*    CLEAR cs_rehu_hu-vlenr_verif.</font>
<font color ="#0000FF">*    lv_add = 'X'.</font>
<font color ="#0000FF">*    lv_length = strlen( cs_rehu_hu-zzbarcode ).</font>
<font color ="#0000FF">*    SHIFT</font>

    IF cs_rehu_hu-zzbarcode IS NOT INITIAL AND cs_rehu_hu-vlenr_verif IS INITIAL.
<font color ="#0000FF">*      PERFORM decode_ean128</font>
<font color ="#0000FF">*               USING    cs_rehu_hu-zzbarcode</font>
<font color ="#0000FF">*               CHANGING ls_ean128_data.</font>
      DATA(lv_line) = strlen( cs_rehu_hu-zzbarcode ).
      IF lv_line NE 20.
        CLEAR cs_rehu_hu-zzbarcode.
        MESSAGE 'Scan 20 digit HU' TYPE 'E'.
      ENDIF.
      cs_rehu_hu-vlenr_verif = cs_rehu_hu-zzbarcode+3.
<font color ="#0000FF">*      lv_ean = ls_ean128_data-matean.</font>
<font color ="#0000FF">*      lv_batch = ls_ean128_data-charg.</font>

<font color ="#0000FF">*    WHILE lv_index &lt; lv_length.</font>
<font color ="#0000FF">*      lv_char = cs_rehu_hu-zzbarcode+lv_index(1).</font>
<font color ="#0000FF">*      IF lv_char = '('.</font>
<font color ="#0000FF">*        lv_add = 'X'.</font>
<font color ="#0000FF">*        CLEAR lv_value.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*      IF lv_add EQ 'X'.</font>
<font color ="#0000FF">*        CONCATENATE lv_value lv_char INTO lv_value.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*      IF lv_value EQ '(21)'.</font>
<font color ="#0000FF">*        CLEAR lv_add.</font>
<font color ="#0000FF">*        IF lv_char NE ')'.</font>
<font color ="#0000FF">*          CONCATENATE cs_rehu_hu-vlenr_verif lv_char INTO cs_rehu_hu-vlenr_verif.</font>
<font color ="#0000FF">*        ENDIF.</font>
<font color ="#0000FF">*      ELSEIF lv_value EQ '(01)'.</font>
<font color ="#0000FF">*        CLEAR lv_add.</font>
<font color ="#0000FF">*        IF lv_char NE ')'.</font>
<font color ="#0000FF">*          CONCATENATE lv_ean lv_char INTO lv_ean.</font>
<font color ="#0000FF">*        ENDIF.</font>
<font color ="#0000FF">*      ELSEIF lv_value EQ '(10)'.</font>
<font color ="#0000FF">*        CLEAR lv_add.</font>
<font color ="#0000FF">*        IF lv_char NE ')'.</font>
<font color ="#0000FF">*          CONCATENATE lv_batch lv_char INTO lv_batch.</font>
<font color ="#0000FF">*        ENDIF.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*      ADD 1 TO lv_index.</font>
<font color ="#0000FF">*    ENDWHILE.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    IF lv_ean IS INITIAL.</font>
<font color ="#0000FF">*      MESSAGE 'Invalid EAN' TYPE 'E'.</font>
<font color ="#0000FF">*    ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*      SELECT SINGLE matid,</font>
<font color ="#0000FF">*                    meinh FROM /sapapo/marm</font>
<font color ="#0000FF">*                          INTO @DATA(ls_marm)</font>
<font color ="#0000FF">*                          WHERE ean11 EQ @lv_ean.</font>
<font color ="#0000FF">*      IF sy-subrc NE 0.</font>
<font color ="#0000FF">*        MESSAGE 'Invalid EAN' TYPE 'E'.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*      SELECT SINGLE matid,</font>
<font color ="#0000FF">*                    matnr FROM /sapapo/matkey</font>
<font color ="#0000FF">*                          INTO @DATA(ls_matkey)</font>
<font color ="#0000FF">*                          WHERE matid EQ @ls_marm-matid.</font>
<font color ="#0000FF">*      IF sy-subrc NE 0.</font>
<font color ="#0000FF">*        MESSAGE 'Invalid EAN' TYPE 'E'.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*      READ TABLE cs_rehu-itms INTO DATA(ls_itms) WITH KEY product-productno = ls_matkey-matnr</font>
<font color ="#0000FF">*                                                          product-batchno   = lv_batch.</font>
<font color ="#0000FF">*      IF sy-subrc NE 0.</font>
<font color ="#0000FF">*        MESSAGE 'Scanned Product and Batch not matching' TYPE 'E'.</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*      CLEAR : gv_matnr,gv_batch.</font>
<font color ="#0000FF">*      gv_matnr = ls_matkey-matnr.</font>
<font color ="#0000FF">*      gv_batch = lv_batch.</font>
<font color ="#0000FF">*</font>
    ENDIF.

    IF cs_rehu_hu-new_packmat IS NOT INITIAL AND cs_rehu_hu-vlenr_verif IS INITIAL.

<font color ="#0000FF">*      Validate Packaging Material</font>
      ls_matnr-sign   = wmegc_sign_inclusive.
      ls_matnr-option = wmegc_option_eq.
      ls_matnr-low    = cs_rehu_hu-new_packmat.
      APPEND ls_matnr TO lt_matnr.

      TRY.
          CALL FUNCTION '/SCWM/MATERIAL_READ_RANGE'
            EXPORTING
              it_matnr_range = lt_matnr
            IMPORTING
              et_matid       = lt_matid.
        CATCH /scwm/cx_md_interface
              /scwm/cx_md_internal_error.
          IF sy-subrc &lt;&gt; 0.
            CLEAR cs_rehu_hu-zzbarcode.
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                       WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
          ENDIF.
      ENDTRY.
      IF lt_matid IS INITIAL.
        CLEAR cs_rehu_hu-zzbarcode.
        "Material &1 does not exist
        MESSAGE e008(zewm_msgs).
      ENDIF.

      DATA(lv_longtext) = cs_rehu_hu-new_packmat.
      DATA(lv1) = lv_longtext(2).
      DATA(lv2) = lv_longtext+2(2).

<font color ="#0000FF">*      CALL FUNCTION 'NUMBER_GET_NEXT'</font>
<font color ="#0000FF">*        EXPORTING</font>
<font color ="#0000FF">*          nr_range_nr             = lv2</font>
<font color ="#0000FF">*          object                  = '/SCWM/HUID'</font>
<font color ="#0000FF">*          subobject               = cs_rehu-lgnum</font>
<font color ="#0000FF">*        IMPORTING</font>
<font color ="#0000FF">*          number                  = cs_rehu_hu-vlenr_verif</font>
<font color ="#0000FF">*        EXCEPTIONS</font>
<font color ="#0000FF">*          interval_not_found      = 1</font>
<font color ="#0000FF">*          number_range_not_intern = 2</font>
<font color ="#0000FF">*          object_not_found        = 3</font>
<font color ="#0000FF">*          quantity_is_0           = 4</font>
<font color ="#0000FF">*          quantity_is_not_1       = 5</font>
<font color ="#0000FF">*          interval_overflow       = 6</font>
<font color ="#0000FF">*          buffer_overflow         = 7</font>
<font color ="#0000FF">*          OTHERS                  = 8.</font>
<font color ="#0000FF">*      IF sy-subrc &lt;&gt; 0.</font>
<font color ="#0000FF">** Implement suitable error handling here</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">*      /scwm/cl_rf_bll_srvc=&gt;set_field( '/SCWM/S_RF_REHU_HU-VLENR_VERIF' ).</font>
<font color ="#0000FF">*      RETURN.</font>
    ENDIF.
  ENDIF.


  lv_field = /scwm/cl_rf_bll_srvc=&gt;get_field( ).
  lv_fcode = /scwm/cl_rf_bll_srvc=&gt;get_fcode( ).
  PERFORM barcode_decoding_hu
  CHANGING cs_rehu_hu.

  /scwm/cl_rf_bll_srvc=&gt;set_prmod( gc_prmod_backgr ).

  CALL FUNCTION 'CONVERSION_EXIT_HUID_INPUT'
    EXPORTING
      input  = cs_rehu_hu-vlenr_verif
    IMPORTING
      output = cs_rehu_hu-huident.

  CALL METHOD /scwm/cl_rf_bll_srvc=&gt;get_fcode
    RECEIVING
      rv_fcode = lv_fcode.

  GET TIME STAMP FIELD lv_timestamp_current.

  IF lv_fcode = gc_fcode_backf.

    IF lo_ewl_manager-&gt;is_standard_skipped( ) = abap_true OR
       cs_rehu-procs IS INITIAL OR
       cs_rehu-prr_id IS INITIAL.
      CALL METHOD /scwm/cl_rf_bll_srvc=&gt;set_fcode
        EXPORTING
          iv_fcode = gc_fcode_updbck.
      RETURN.
    ENDIF.

    "Close and save current EWL
    "function code 'back' means end of transaction
    "-&gt; commit the EWL as well
    lo_ewl_manager-&gt;close( iv_end_actual = lv_timestamp_current ).

    lo_ewl_manager-&gt;save( ).
    COMMIT WORK AND WAIT.
    lo_ewl_manager-&gt;cleanup( ).

    CALL METHOD /scwm/cl_rf_bll_srvc=&gt;set_fcode
      EXPORTING
        iv_fcode = gc_fcode_updbck.
    RETURN.
  ENDIF.

  CASE lv_fcode .
    WHEN gc_fcode_gtnwhu.
<font color ="#0000FF">* set mass hu creation indicator to false</font>
      gv_mass_hu_create = abap_false.

      PERFORM check_hu_exists
        USING cs_rehu_hu-huident
        CHANGING lv_exist.

      IF lv_exist = 'X'.
        CALL FUNCTION 'DEQUEUE_/SCWM/EHU'
          EXPORTING
            mode_/scwm/s_huhdr_int = 'E'
            mandt                  = sy-mandt
            huident                = cs_rehu_hu-huident
            lgnum                  = cs_rehu-lgnum.
        CLEAR:cs_rehu_hu-vlenr_verif,cs_rehu_hu-zzbarcode.
        MESSAGE e420(/scwm/rf_en) WITH cs_rehu_hu-huident.
      ENDIF.
      IF cs_rehu_hu-huident IS NOT INITIAL.
        PERFORM hu_number_range_check
          USING cs_rehu_hu
                cs_rehu-lgnum.
      ENDIF.

      CALL METHOD /scwm/cl_rf_bll_srvc=&gt;set_fcode
        EXPORTING
          iv_fcode = gc_fcode_gtnwhu.

      IF lo_ewl_manager-&gt;is_standard_skipped( ) = abap_true OR
         cs_rehu-procs IS INITIAL OR
         cs_rehu-prr_id IS INITIAL.
        RETURN.
      ENDIF.
      "Close and save current EWL
      lo_ewl_manager-&gt;close(
        EXPORTING
          iv_end_actual = lv_timestamp_current
        IMPORTING
          eo_message    = DATA(lo_message) ).

      "Open new EWL
      lo_ewl_manager-&gt;open(
        EXPORTING
          iv_lgnum        = cs_rehu-lgnum
          iv_procs        = cs_rehu-procs
          iv_prr_id       = cs_rehu-prr_id
          iv_start_actual = lv_timestamp_current ).
      RETURN.

<font color ="#0000FF">*      ELSE.</font>
<font color ="#0000FF">*        RETURN.</font>
<font color ="#0000FF">*      ENDIF.</font>
    WHEN gc_fcode_gtnmhu.
<font color ="#0000FF">*      IF cs_rehu_hu-huident IS NOT INITIAL.</font>
<font color ="#0000FF">*        MESSAGE e820(/scwm/rf_en).</font>
<font color ="#0000FF">*      ENDIF.</font>
<font color ="#0000FF">** set mass hu creation indicator to true</font>
<font color ="#0000FF">*      gv_mass_hu_create = abap_true.</font>

      cs_rehu_hu-zzpallet_verif = cs_rehu_hu-vlenr_verif.
      DATA : ls_mat_global TYPE /scwm/s_material_global,    "#EC NEEDED
             ls_mat_pack   TYPE  /scwm/s_material_pack.
      DATA lo_pack         TYPE REF TO /scwm/cl_dlv_pack_ibdl.
      DATA ls_docid_query  TYPE /scwm/dlv_docid_item_str.
      DATA lt_docid_query  TYPE /scwm/dlv_docid_item_tab.

      IF  cs_rehu_hu-vlenr_verif IS INITIAL.
        MESSAGE e374(/scwm/rf_en).
      ELSE.

        IF cs_rehu_hu-new_packmat IS NOT INITIAL.
<font color ="#0000FF">*      Validate Packaging Material</font>
          ls_matnr-sign   = wmegc_sign_inclusive.
          ls_matnr-option = wmegc_option_eq.
          ls_matnr-low    = cs_rehu_hu-new_packmat.
          APPEND ls_matnr TO lt_matnr.

          TRY.
              CALL FUNCTION '/SCWM/MATERIAL_READ_RANGE'
                EXPORTING
                  it_matnr_range = lt_matnr
                IMPORTING
                  et_matid       = lt_matid.
            CATCH /scwm/cx_md_interface
                  /scwm/cx_md_internal_error.
              IF sy-subrc &lt;&gt; 0.
                CLEAR cs_rehu_hu-zzbarcode.
                MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                           WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
              ENDIF.
          ENDTRY.
          IF lt_matid IS INITIAL.
            CLEAR cs_rehu_hu-zzbarcode.
            "Material &1 does not exist
            MESSAGE e008(zewm_msgs).
          ENDIF.
        ENDIF.
<font color ="#0000FF">* Read pallet pack mat data</font>
        READ TABLE lt_matid ASSIGNING FIELD-SYMBOL(&lt;fs_s_matid&gt;) INDEX 1.
        IF sy-subrc EQ 0.

          TRY.
              CALL FUNCTION '/SCWM/MATERIAL_READ_SINGLE'
                EXPORTING
                  iv_matid      = &lt;fs_s_matid&gt;-matid
                  iv_lgnum      = cs_rehu-lgnum
                IMPORTING
                  es_mat_global = ls_mat_global
                  es_mat_pack   = ls_mat_pack.
            CATCH /scwm/cx_md_interface
            /scwm/cx_md_material_exist
            /scwm/cx_md_mat_lgnum_exist
            /scwm/cx_md_lgnum_locid
            /scwm/cx_md.                                "#EC NO_HANDLER
              CLEAR cs_rehu_hu-zzbarcode.
              MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
          ENDTRY.
        ENDIF.
        IF ls_mat_pack-pmtyp IS INITIAL.
          CLEAR cs_rehu_hu-zzbarcode.
          MESSAGE e422(/scwm/rf_en) WITH cs_rehu_hu-new_packmat.
        ELSE.
          lv_huident = cs_rehu_hu-zzpallet_verif.
          cs_rehu_hu-zzpallet_pmatid =  &lt;fs_s_matid&gt;-matid.
<font color ="#0000FF">* Simulate pallet creation to check for errors</font>
          CALL FUNCTION '/SCWM/HU_READ'
            EXPORTING
              iv_appl    = 'WME'
              iv_lgnum   = cs_rehu-lgnum
              iv_huident = lv_huident
            IMPORTING
              es_huhdr   = ls_huhead
            EXCEPTIONS
              deleted    = 1
              not_found  = 2
              error      = 3
              OTHERS     = 4.
          IF sy-subrc EQ 0 AND ls_huhdr IS INITIAL.
            IF lo_pack IS NOT BOUND.
              CREATE OBJECT lo_pack.
            ENDIF.

            CLEAR ls_docid_query.
            READ TABLE cs_rehu-deliveries INTO DATA(ls_rehu) INDEX 1.
            ls_docid_query-docid  = ls_rehu-docid.
            ls_docid_query-doccat = ls_rehu-doccat.
            APPEND ls_docid_query TO lt_docid_query.
            DATA(lv_found) = lo_pack-&gt;/scwm/if_pack_bas~hu_existence_check( lv_huident ).

            IF lv_found = abap_false AND cs_rehu_hu-vlenr_verif IS NOT INITIAL.

              CALL METHOD lo_pack-&gt;/scwm/if_pack_bas~create_hu
                EXPORTING
                  iv_pmat    = &lt;fs_s_matid&gt;-matid
                  iv_huident = lv_huident
                RECEIVING
                  es_huhdr   = ls_huhdr
                EXCEPTIONS
                  error      = 1
                  OTHERS     = 2.
              IF sy-subrc &lt;&gt; 0.
                CLEAR cs_rehu_hu-zzbarcode.
                MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                           WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
              ENDIF.

<font color ="#0000FF">* save</font>
              CALL METHOD lo_pack-&gt;/scwm/if_pack_bas~save
                EXPORTING
                  iv_commit = ' '
                  iv_wait   = ' '
                EXCEPTIONS
                  error     = 1
                  OTHERS    = 2.
              IF sy-subrc &lt;&gt; 0.
                CLEAR cs_rehu_hu-zzbarcode.
                MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                           WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
<font color ="#0000FF">*  Fetch nested HU number</font>
        SELECT SINGLE lgnum, pmtyp, int_nr
      FROM /scwm/thunr
      INTO @DATA(ls_hunr)
      WHERE lgnum = @cs_rehu-lgnum
      AND   pmtyp = 'NSHP'.
        CALL FUNCTION 'NUMBER_GET_NEXT'
          EXPORTING
            nr_range_nr             = ls_hunr-int_nr
            object                  = '/SCWM/HUID'
            subobject               = cs_rehu-lgnum
          IMPORTING
            number                  = cs_rehu_hu-huident
          EXCEPTIONS
            interval_not_found      = 1
            number_range_not_intern = 2
            object_not_found        = 3
            quantity_is_0           = 4
            quantity_is_not_1       = 5
            interval_overflow       = 6
            buffer_overflow         = 7
            OTHERS                  = 8.
        IF sy-subrc &lt;&gt; 0.
<font color ="#0000FF">* Implement suitable error handling here</font>
        ENDIF.
      ENDIF.
    WHEN gc_fcode_pgrhdr.
      DATA: lv_process  TYPE boole_d VALUE abap_false.

      IF gc_ltrans_rhdesi = /scwm/cl_rf_bll_srvc=&gt;get_ltrans_real( )
      OR lines( cs_rehu-deliveries ) = 1.
        lv_process = abap_true.
      ENDIF.

      IF lv_process = abap_true AND ( cs_rehu IS INITIAL OR cs_rehu-deliveries IS INITIAL ).
        lv_process = abap_false.
      ENDIF.

      IF lv_process = abap_true.
<font color ="#0000FF">* lock delivery headers</font>
        DATA: lt_sp_k_head        TYPE /scdl/t_sp_k_head.
        DATA: ls_sp_k_head        TYPE /scdl/s_sp_k_head.

        ls_sp_k_head-docid = cs_rehu-deliveries[ 1 ]-docid.
        APPEND ls_sp_k_head TO lt_sp_k_head.

        DATA(lo_sp) = /scwm/cl_dlv_management_prd=&gt;get_instance( )-&gt;get_service_provider( wmegc_doccat_pdi ).
        lo_sp-&gt;lock(
          EXPORTING
            inkeys       = lt_sp_k_head
            aspect       = /scdl/if_sp_c=&gt;sc_asp_head
            lockmode     = /scdl/if_sp1_locking=&gt;sc_exclusive_lock
          IMPORTING
            rejected     = DATA(lv_rejected)
            return_codes = DATA(lt_return_code) ).

        IF lv_rejected IS NOT INITIAL OR lt_return_code IS NOT INITIAL.
          lv_process = abap_false.
          MESSAGE e337(/scwm/rf_en).
        ELSE.
          lv_process = abap_true.
        ENDIF.
      ENDIF.

      IF lv_process = abap_true.
<font color ="#0000FF">* read pgr status again</font>
        DATA lt_dlv    TYPE /scwm/dlv_docid_item_tab.
        DATA: ls_dlv   LIKE LINE OF lt_dlv,
              lt_huref TYPE /scwm/tt_huref_int.
        ls_dlv-docid  = cs_rehu-deliveries[ 1 ]-docid.
        ls_dlv-doccat = cs_rehu-deliveries[ 1 ]-doccat.
        APPEND ls_dlv TO lt_dlv.
<font color ="#0000FF">* collect the HUs for the deliveries</font>
        "refresh HUs first
        CALL FUNCTION '/SCWM/DLV_GET_HUS_FOR_DELIVERY'
          EXPORTING
            it_docid       = VALUE /scwm/tt_docid( ( docid = cs_rehu-deliveries[ 1 ]-docid ) )
            iv_refresh_dlv = 'X'
          EXCEPTIONS
            error          = 1
            OTHERS         = 2.
        CALL FUNCTION '/SCWM/DLV_GET_HUS_FOR_DELIVERY'
          EXPORTING
            iv_doccat = /scdl/if_dl_doc_c=&gt;sc_doccat_inb_prd
            it_docid  = VALUE /scwm/tt_docid( ( docid = cs_rehu-deliveries[ 1 ]-docid ) )
          IMPORTING
            et_huref  = lt_huref
          EXCEPTIONS
            error     = 1
            OTHERS    = 2.

        IF sy-subrc &lt;&gt; 0.
          MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
        ENDIF.
        "refresh number of HUs
        "fix issue 2280010260
        DELETE lt_huref WHERE docid &lt;&gt; cs_rehu-deliveries[ 1 ]-docid.
        cs_rehu-sumhu = lines( lt_huref ).

        DATA(lo_dlv) = /scwm/cl_dlv_management_prd=&gt;get_instance( ).

        /scwm/cl_tm=&gt;cleanup( ).

        DATA(ls_read_options) = VALUE /scwm/dlv_query_contr_str( data_retrival_only = abap_true ).
        DATA(ls_include_data) = VALUE /scwm/dlv_query_incl_str_prd( head_status = abap_true
                                                                    head_status_dyn = /scwm/if_dl_c=&gt;sc_h_stat_dyn_calc_all_items ).
        ls_include_data-head_status_dyn_detail = VALUE #( ( /scdl/if_dl_status_c=&gt;sc_t_packing )
                                                          ( /scdl/if_dl_status_c=&gt;sc_t_goods_receipt ) ).

        TRY.
            lo_dlv-&gt;query(
              EXPORTING
                it_docid        = lt_dlv
                iv_doccat       = /scdl/if_dl_doc_c=&gt;sc_doccat_inb_prd
                is_read_options = ls_read_options
                is_include_data = ls_include_data
              IMPORTING
                et_headers      = DATA(lt_prd_hdr) ).
          CATCH /scdl/cx_delivery.
            lv_process = abap_false.
        ENDTRY.

        IF lt_prd_hdr IS NOT INITIAL.
          READ TABLE lt_prd_hdr INTO DATA(ls_prd_hdr) INDEX 1.
          cs_rehu-pack = abap_false.
          cs_rehu-pgr = abap_false.
          IF line_exists( ls_prd_hdr-status[ status_type  = /scdl/if_dl_status_c=&gt;sc_t_packing
                                             status_value = /scdl/if_dl_status_c=&gt;sc_v_finished ]  ) .
            cs_rehu-pack = abap_true.
          ENDIF .
          IF line_exists( ls_prd_hdr-status[ status_type  = /scdl/if_dl_status_c=&gt;sc_t_goods_receipt
                                             status_value = /scdl/if_dl_status_c=&gt;sc_v_finished ]  ) .
            cs_rehu-pgr = abap_true.
          ENDIF.
        ENDIF.
      ENDIF.

      IF lv_process = abap_true.
        IF cs_rehu-pgr = abap_true.
          lv_process = abap_false.

          lo_sp-&gt;unlock(
            EXPORTING
              inkeys   = lt_sp_k_head
              aspect   = /scdl/if_sp_c=&gt;sc_asp_head
            IMPORTING
              rejected = lv_rejected ).

          IF lv_rejected IS NOT INITIAL.
            MESSAGE e193(/scwm/rf_en).
          ENDIF.

          MESSAGE e333(/scwm/rf_en).
        ENDIF.
      ENDIF.

      IF lv_process = abap_true AND cs_rehu-pack = abap_false.
        IF /scwm/cl_rf_dynpro_srvc=&gt;display_message(
            iv_msgid           = '/SCWM/RF_EN'
            iv_msgty           = /scwm/cl_rf_bll_srvc=&gt;c_msgty_query
            iv_msgno           = '824' ) &lt;&gt; /scwm/cl_rf_bll_srvc=&gt;c_answer_yes.

          lv_process = abap_false.

          lo_sp-&gt;unlock(
            EXPORTING
              inkeys   = lt_sp_k_head
              aspect   = /scdl/if_sp_c=&gt;sc_asp_head
            IMPORTING
              rejected = lv_rejected ).

          IF lv_rejected IS NOT INITIAL.
            MESSAGE e193(/scwm/rf_en).
          ENDIF.
        ENDIF.
      ENDIF.

      IF lv_process = abap_true.
        /scwm/cl_goods_movement=&gt;/scwm/if_gm_dlv~post_dlv(
          EXPORTING
            it_dlv     = lt_dlv
            iv_gmcat   = /scdl/if_dl_doc_c=&gt;sc_doccat_gr
          IMPORTING
            eo_message = DATA(lo_message_pgr) ).

        IF lo_message_pgr IS BOUND.
          DATA(lt_message) = lo_message_pgr-&gt;get_messages( iv_msgty = 'E' ).
<font color ="#0000FF">* check whether the message contains errors</font>
          READ TABLE lt_message INTO DATA(ls_message) WITH KEY msgty = 'E'.
<font color ="#0000FF">* contains error.</font>
          IF sy-subrc IS INITIAL AND ls_message IS NOT INITIAL.
            lv_process = abap_false.
            /scwm/cl_tm=&gt;cleanup( ).

            MESSAGE ID ls_message-msgid TYPE ls_message-msgty NUMBER ls_message-msgno
              WITH ls_message-msgv1 ls_message-msgv2
                   ls_message-msgv3 ls_message-msgv4.
          ENDIF.
        ENDIF.
      ENDIF.

      IF lv_process = abap_true.
        DATA(lo_dlv_save) = /scwm/cl_dlv_management_prd=&gt;get_instance( ).
        lo_dlv_save-&gt;save(
          IMPORTING
            ev_rejected = DATA(lv_rejected_save)
            et_message  = DATA(lt_message_save) ).

        IF lt_message_save IS NOT INITIAL.
<font color ="#0000FF">*  check whether the message contains errors</font>
          READ TABLE lt_message_save INTO DATA(ls_message_save) WITH KEY msgty = 'E'.
<font color ="#0000FF">*  contains error.</font>
          IF sy-subrc IS INITIAL AND ls_message_save IS NOT INITIAL.
            lv_process = abap_false.
            ROLLBACK WORK.

            MESSAGE ID ls_message_save-msgid TYPE ls_message_save-msgty NUMBER ls_message_save-msgno
            WITH ls_message_save-msgv1 ls_message_save-msgv2
                 ls_message_save-msgv3 ls_message_save-msgv4.
          ENDIF.
        ENDIF.

      ENDIF.

      IF lv_process = abap_true.
        COMMIT WORK AND WAIT.
        "update status for HU and proc HUs, at this point, cs_rehu-hus is not reliable anymore
        cs_rehu-sumhu_proc += lines( lt_huref ).
        LOOP AT cs_rehu-hus ASSIGNING FIELD-SYMBOL(&lt;hus&gt;) WHERE docid = lt_dlv[ 1 ]-docid. "newly added HU will not have doccat info filled.
          &lt;hus&gt;-pgr = abap_true.
<font color ="#0000FF">*          cs_rehu-sumhu_proc = cs_rehu-sumhu_proc + 1.</font>
        ENDLOOP.
      ENDIF.

      /scwm/cl_tm=&gt;cleanup( ).

    WHEN OTHERS.

  ENDCASE.

  READ TABLE cs_rehu-hus WITH KEY huident = cs_rehu_hu-huident
                         TRANSPORTING NO FIELDS.

  IF sy-subrc = 0.

    READ TABLE cs_rehu-hus INTO cs_rehu_hu
                           WITH KEY huident = cs_rehu_hu-huident
                                    .
    IF sy-subrc NE 0.
      MESSAGE e415(/scwm/rf_en).
    ENDIF.

<font color ="#0000FF">*   CREATE OBJECT lo_prd2hum.</font>
    IF lo_prd2hum IS NOT BOUND.
      CREATE OBJECT lo_prd2hum.
    ENDIF.

    TRY.
        CALL METHOD lo_prd2hum-&gt;check_cross_hu
          EXPORTING
            iv_guid_hu  = cs_rehu_hu-guid_hu
          IMPORTING
            ev_cross_hu = cs_rehu_hu-cross_hu.
      CATCH
        /scdl/cx_delivery.                              "#EC NO_HANDLER

    ENDTRY.

<font color ="#0000FF">*   refresh HU memory for given HU because qty conversion could</font>
<font color ="#0000FF">*   lead to wrong data</font>
    MOVE cs_rehu_hu-guid_hu TO ls_hu_guids-guid_hu.
    APPEND ls_hu_guids TO lt_hu_guids.

    CALL FUNCTION '/SCWM/HUMAIN_REFRESH'
      EXPORTING
        it_hu_guids = lt_hu_guids.

    PERFORM hu_read_and_lock
      USING    cs_rehu_hu-huident
               cs_rehu-lgnum
               cs_rehu-deliveries
               abap_false
      CHANGING ls_huhdr
               lt_huitm
               cs_rehu_hu-hazmat_ind
               cs_rehu_hu-rdoccat
               cs_rehu_hu-rdocid.

    CLEAR: ct_rehu_prod, cs_rehu_prod.

    PERFORM fill_prod_data_from_huitem
      USING    cs_rehu-lgnum
               lt_huitm
               cs_rehu_hu-huident
      CHANGING cs_rehu_prod
               ct_rehu_prod.

    CALL METHOD /scwm/cl_rf_bll_srvc=&gt;set_fcode
      EXPORTING
        iv_fcode = gc_fcode_gtexhu.

    IF lo_ewl_manager-&gt;is_standard_skipped( ) = abap_true OR
       cs_rehu-procs IS INITIAL OR
       cs_rehu-prr_id IS INITIAL.
      RETURN.
    ENDIF.

    "Close and save current EWL
    lo_ewl_manager-&gt;close(
      EXPORTING
        iv_end_actual = lv_timestamp_current
      IMPORTING
        eo_message    = lo_message ).

    "Open new EWL
    lo_ewl_manager-&gt;open(
      EXPORTING
        iv_lgnum        = cs_rehu-lgnum
        iv_procs        = cs_rehu-procs
        iv_prr_id       = cs_rehu-prr_id
        iv_start_actual = lv_timestamp_current ).

    RETURN.

  ELSE.

    IF cs_rehu_hu-huident IS INITIAL.

      /scwm/cl_rf_bll_srvc=&gt;set_prmod( gc_prmod_foregr ).

      CALL METHOD /scwm/cl_rf_bll_srvc=&gt;set_field
        EXPORTING
          iv_field = 'CS_REHU_HU-ZZBARCODE'.

    ELSE.

      PERFORM check_for_other_delivery
        USING cs_rehu_hu-huident
              cs_rehu-lgnum
        CHANGING lv_exist_in_other_delivery.

      IF lv_exist_in_other_delivery IS NOT INITIAL.
        MESSAGE e430(/scwm/rf_en) WITH cs_rehu_hu-huident.
      ENDIF.

<font color ="#0000FF">*      "Check whether it's Adv. S & R (only for first release version)</font>
<font color ="#0000FF">*      READ TABLE cs_rehu-deliveries TRANSPORTING NO FIELDS</font>
<font color ="#0000FF">*      WITH KEY advsr = abap_true.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*      IF sy-subrc IS INITIAL.</font>
<font color ="#0000FF">*        "HU &1 does not exist</font>
<font color ="#0000FF">*        MESSAGE e873(/scwm/rf_en) WITH cs_rehu_hu-huident.</font>
<font color ="#0000FF">*      ELSE.</font>

      "For original(non-Adv.S&R) go to HU creation screen
      /scwm/cl_rf_bll_srvc=&gt;set_fcode( gc_fcode_gtnwhu ).

      IF lo_ewl_manager-&gt;is_standard_skipped( ) = abap_true OR
         cs_rehu-procs IS INITIAL OR
         cs_rehu-prr_id IS INITIAL.
        RETURN.
      ENDIF.

      "Close and save current EWL
      lo_ewl_manager-&gt;close(
        EXPORTING
          iv_end_actual = lv_timestamp_current
        IMPORTING
          eo_message    = lo_message ).

      "Open new EWL
      lo_ewl_manager-&gt;open(
        EXPORTING
          iv_lgnum        = cs_rehu-lgnum
          iv_procs        = cs_rehu-procs
          iv_prr_id       = cs_rehu-prr_id
          iv_start_actual = lv_timestamp_current ).

<font color ="#0000FF">*      ENDIF.    "For Adv. s & R</font>

    ENDIF.

  ENDIF.

ENDFUNCTION.


<font color ="#0000FF">*Messages</font>
<font color ="#0000FF">*----------------------------------------------------------</font>
<font color ="#0000FF">*YPE</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/BATCH</font>
<font color ="#0000FF">*008   No batch class found for product &1</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/DLV_BATCH</font>
<font color ="#0000FF">*006   Batch Creation Not Allowed for Item Type &1, Document Type &2, Whse &3</font>
<font color ="#0000FF">*007   Batch Creation Not Allowed</font>
<font color ="#0000FF">*206   Product &1 subject to batch management requirement</font>
<font color ="#0000FF">*303   Enter shelf life expiration or best-before date</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/DLV_EGR</font>
<font color ="#0000FF">*335   Advanced S&R data does not support Expected Goods Receipt Process.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/HU_WM</font>
<font color ="#0000FF">*043   HU number &1 is internal and cannot be assigned externally</font>
<font color ="#0000FF">*085   &1 does not lie in a defined number range interval for this HU</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/L1</font>
<font color ="#0000FF">*700   Unit of measure & not supported for the product</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/MD</font>
<font color ="#0000FF">*000   &1 &2 &3 &4 &5</font>
<font color ="#0000FF">*002   Product does not exist</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/RF_DE</font>
<font color ="#0000FF">*010   Warehouse number is not predefined</font>
<font color ="#0000FF">*014   Handling unit &1 is not scheduled</font>
<font color ="#0000FF">*057   Enter a valid means of transport</font>
<font color ="#0000FF">*064   Handling unit &1 cannot be unloaded</font>
<font color ="#0000FF">*092   Enter a storage bin</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/RF_EN</font>
<font color ="#0000FF">*193   Object is locked; processing not possible</font>
<font color ="#0000FF">*290   Error in update for receiving of HU &1</font>
<font color ="#0000FF">*319   Error adjusting Handling Unit item quantity</font>
<font color ="#0000FF">*333   Goods receipt already posted</font>
<font color ="#0000FF">*337   Error locking Delivery</font>
<font color ="#0000FF">*374   Enter HU</font>
<font color ="#0000FF">*404   Enter positive quantity (&gt;0)</font>
<font color ="#0000FF">*415   HU is already processed</font>
<font color ="#0000FF">*420   Handling unit &1 already exists in the warehouse</font>
<font color ="#0000FF">*421   Material &1 does not exist</font>
<font color ="#0000FF">*422   Material &1 is not a packaging material</font>
<font color ="#0000FF">*430   HU &1 is related to other delivery</font>
<font color ="#0000FF">*436   BBD &1 does not match the inbound delivery item</font>
<font color ="#0000FF">*491   Delivery quantity exceeded</font>
<font color ="#0000FF">*604   Only integer value is valid</font>
<font color ="#0000FF">*605   Selected value &1 is too large</font>
<font color ="#0000FF">*822   Can’t process serial-number-managed products when creating multiple HUs</font>
<font color ="#0000FF">*823   Can’t create multiple HUs for a product that isn't in an inbound delivery</font>
<font color ="#0000FF">*894   Creation of batch &1 failed for material &2</font>
<font color ="#0000FF">*897   Invalid stock segment &1 for product &2</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: /SCWM/UI_PACKING</font>
<font color ="#0000FF">*049   An error has occurred (probably a program error)</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: &lt;LFS_MESSAGES&gt;-MSGID</font>
<font color ="#0000FF">*&lt;LF</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: Hard coded</font>
<font color ="#0000FF">*   Please enter Packaging Material</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: LS_BAPIRET-ID</font>
<font color ="#0000FF">*LS_</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: LS_MESSAGE-ID</font>
<font color ="#0000FF">*LS_</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: LS_MESSAGE-MSGID</font>
<font color ="#0000FF">*LS_</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: LS_MESSAGE_SAVE-MSGI</font>
<font color ="#0000FF">*LS_</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">* Message class: ZEWM_MSGS</font>
<font color ="#0000FF">*008   Material &1 does not exist</font>
<font color ="#0000FF">*026   Please enter Qty</font>
<font color ="#0000FF">*027   Please enter data and proceed</font>
<font color ="#0000FF">*032   Doc. Type &1 is not allowed for this Transaction</font>
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 757
</font>
</body>
</html>
